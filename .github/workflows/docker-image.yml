name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get existing Docker Hub tags
        id: get_tags
        run: |
          echo "Fetching tags from Docker Hub..."
          TAGS=$(curl -s "https://registry.hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/ticket-flow-app/tags?page_size=100" | jq -r '.results[].name')

          echo "--- Existing Tags ---"
          echo "$TAGS"

          # Filter only version tags like version1, version10
          VERSION_TAGS=$(echo "$TAGS" | grep -E '^version[0-9]+$' || true)

          echo "--- Version Tags ---"
          echo "$VERSION_TAGS"

          if [ -z "$VERSION_TAGS" ]; then
            # No tags found â†’ start with version1
            NEW_TAG="version1"
          else
            # Extract numbers, sort, pick highest, increment
            LAST_NUM=$(echo "$VERSION_TAGS" | sed 's/version//' | sort -n | tail -1)
            NEXT_NUM=$((LAST_NUM + 1))
            NEW_TAG="version${NEXT_NUM}"
          fi

          echo "New tag will be: $NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/ticket-flow-app:${{ steps.get_tags.outputs.new_tag }} .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/ticket-flow-app:${{ steps.get_tags.outputs.new_tag }}
